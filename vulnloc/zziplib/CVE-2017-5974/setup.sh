project_name=zziplib
bug_id=CVE-2017-5974
dir_name=$1/vulnloc/$project_name/$bug_id

current_dir=$PWD
mkdir -p $dir_name
cd $dir_name
git clone https://github.com/gdraheim/zziplib.git src
cd src
git checkout 3a4ffcd
cd docs/
wget https://github.com/LuaDist/libzzip/raw/master/docs/zziplib-manpages.tar
cd ../

CC=wllvm CXX=wllvm++ ./configure CFLAGS='-g -O0 -static'
# CC=wllvm CXX=wllvm++ make -j32

sed -i '224i klee_assert( ext2_backup+2-sizeof(*block) >= 0 );\n' zzip/memdisk.c
sed -i '224i TRIDENT_OUTPUT("obs", "i32", ext2_backup+2-sizeof(*block));' zzip/memdisk.c
sed -i '197i if(__trident_choice("L1634", "bool", (int[]){ext2, ext1, sizeof(zzip_extra_zip64), ptr1, ptr2}, (char*[]){"x", "y", "z", "m", "n"}, 5, (int*[]){}, (char*[]){}, 0)) { errno = EBADMSG; return 0; }' zzip/memdisk.c
sed -i '197i ext2_backup = ext2;' zzip/memdisk.c
sed -i '191i int ext2_backup;' zzip/memdisk.c
sed -i '44i #ifndef TRIDENT_OUTPUT\n#define TRIDENT_OUTPUT(id, typestr, value) value\n#endif\n' zzip/memdisk.c
sed -i '44i #include <klee/klee.h>' zzip/memdisk.c
# git add libtiff/tif_dirwrite.c
# git commit -m "instrument trident"

make CC=$TRIDENT_CC CFLAGS="-lkleeRuntest -L/klee/build/lib -I/klee/source/include -ltrident_proxy -L/CPR/lib -g -O0 -static" -j32

cp Linux_5.4.0-94-generic_x86_64.d/bins/unzzipcat-mem .

cd $current_dir
cp repair.conf $dir_name
cp spec.smt2 $dir_name
cp t1.smt2 $dir_name
cp -rf components $dir_name
cp exploit $dir_name
